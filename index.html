<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Overton Window Ontology Graphic</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Three.js Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <!-- React and ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- Babel for JSX Transpilation -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        body, html, #root {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow-x: hidden;
        }
        .custom-scrollbar::-webkit-scrollbar {
            width: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: transparent;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #4b5563;
            border-radius: 10px;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;

        // ==========================================
        // DATASETS (The Ontology Library)
        // ==========================================
        const DATASETS = {
            health_ip: {
                title: "Commercial Access & IP in Health Research",
                groups: [
                    { id: 'patient', name: 'Patient Advocates', color: '#00E676' },
                    { id: 'nhs_gov', name: 'NHS & Gov Leadership', color: '#FF1744' },
                    { id: 'industry', name: 'Pharma & Tech Industry', color: '#FF9100' },
                    { id: 'academic', name: 'Academic Researchers', color: '#00E5FF' },
                    { id: 'legal', name: 'Legal & Ethicists', color: '#2979FF' }
                ],
                windows: {
                    'all': { min: -3, max: 3, label: 'General Consensus' },
                    'protectionism': { min: -9, max: -1, label: 'Protectionism Block' },
                    'collaboration': { min: -2, max: 4, label: 'Collaboration Block' },
                    'privatization': { min: 3, max: 9, label: 'Privatization Block' }
                },
                yAxis: [
                    { id: 'evidence', label: 'Innovation Impact', description: 'Acceleration of treatments (0-10)' },
                    { id: 'equitability', label: 'Public Trust', description: 'Social license & fairness (0-10)' },
                    { id: 'salience', label: 'Feasibility', description: 'Technical/Political reality (0-10)' }
                ],
                policies: [
                    { id: 1, title: 'Full Commercial Ban', description: 'No for-profit access to NHS data under any circumstances.', position: -9, parties: ['patient'], status: 'Unthinkable', source: 'https://medconfidential.org', stats: [{ text: "1.5m opt-outs in one month (2021) showed the scale of public distrust.", sourceUrl: "https://digital.nhs.uk/services/national-data-opt-out/statistics" }], evidence: 1, equitability: 9, salience: 6 },
                    { id: 2, title: 'Data Sovereign Wealth Fund', description: 'National fund holding IP stakes in all products derived from NHS data.', position: -7, parties: ['patient', 'nhs_gov'], status: 'Radical', source: 'https://www.ippr.org', stats: [{ text: "NHS data estimated to be worth £9.6bn/year to commercial sector.", sourceUrl: "https://www.ey.com/en_uk/news/2019/07/nhs-data-value" }], evidence: 5, equitability: 10, salience: 7 },
                    { id: 3, title: 'Individual Data Dividends', description: 'Micro-payments to patients every time their specific record is used.', position: -8, parties: ['patient'], status: 'Unthinkable', source: 'https://www.bristol.ac.uk', stats: [{ text: "62% of public believe they should financially benefit directly.", sourceUrl: "https://www.bristol.ac.uk/policybristol/policy-briefings/nhs-data-value/" }], evidence: 2, equitability: 8, salience: 4 },
                    { id: 4, title: 'Dynamic Consent Portals', description: 'Real-time app allowing patients to toggle access for specific companies.', position: -5, parties: ['patient'], status: 'Radical', source: 'https://www.usemydata.org', stats: [{ text: "Granular control increases trust by 24%.", sourceUrl: "https://understandingpatientdata.org.uk" }], evidence: 4, equitability: 10, salience: 5 },
                    { id: 5, title: 'Citizen Data Juries', description: 'Lay panels with veto power over commercial access requests.', position: -3, parties: ['patient', 'legal'], status: 'Acceptable', source: 'https://www.adruk.org', stats: [{ text: "OneLondon deliberations showed strong support for strict conditions.", sourceUrl: "https://www.onelondon.online" }], evidence: 6, equitability: 9, salience: 6 },
                    { id: 6, title: 'No IP Transfer', description: 'Companies can use data but NHS retains 100% of resulting IP.', position: -4, parties: ['patient', 'academic'], status: 'Acceptable', source: 'https://weownit.org.uk', stats: [{ text: "Public ownership of IP is seen as key to 'NHS values'.", sourceUrl: "https://weownit.org.uk/nhs-data-grab" }], evidence: 3, equitability: 8, salience: 5 },
                    { id: 7, title: 'Transparency Registers', description: 'Public log of every commercial access request and outcome.', position: 0, parties: ['patient', 'nhs_gov', 'legal'], status: 'Policy', source: 'https://www.data.gov.uk', stats: [{ text: "Only 34% of public know how NHS uses data.", sourceUrl: "https://theodi.org" }], evidence: 7, equitability: 8, salience: 4 },
                    { id: 8, title: 'Strict Purpose Limitation', description: 'Data only for health outcomes, never for insurance/marketing.', position: -1, parties: ['patient', 'legal', 'industry'], status: 'Policy', source: 'https://www.ndg.org.uk', stats: [{ text: "91% support health research; <50% support commercial insurance use.", sourceUrl: "https://www.rcgp.org.uk" }], evidence: 8, equitability: 9, salience: 3 },
                    { id: 9, title: 'Opt-Out Universality', description: 'National Opt-out applies to ALL anonymized commercial feeds.', position: -2, parties: ['patient', 'legal'], status: 'Sensible', source: 'https://digital.nhs.uk', stats: [{ text: "Current exemptions for 'anonymised' data confuse the public.", sourceUrl: "https://medconfidential.org" }], evidence: 5, equitability: 9, salience: 8 },
                    { id: 10, title: 'Right to Be Forgotten', description: 'Absolute right to delete data from trained AI models.', position: -6, parties: ['patient', 'legal'], status: 'Radical', source: 'https://ico.org.uk', stats: [{ text: "'Machine unlearning' is technically difficult but ethically demanded.", sourceUrl: "https://www.turing.ac.uk" }], evidence: 2, equitability: 9, salience: 6 },
                    { id: 11, title: 'Value Sharing Framework', description: 'Charging fair market value to fund NHS digitization.', position: 1, parties: ['nhs_gov'], status: 'Policy', source: 'https://transform.england.nhs.uk', stats: [{ text: "NHS creates £10bn+ value; aiming to capture a fraction for reinvestment.", sourceUrl: "https://www.gov.uk" }], evidence: 8, equitability: 7, salience: 7 },
                    { id: 12, title: 'Federated Data Platform', description: 'Central OS connecting trusts to industry partners.', position: 3, parties: ['nhs_gov'], status: 'Contested', source: 'https://www.england.nhs.uk', stats: [{ text: "£330m Palantir contract sparked major legal challenges.", sourceUrl: "https://www.foxglove.org.uk" }], evidence: 9, equitability: 4, salience: 10 },
                    { id: 13, title: 'Secure Data Environments (SDE)', description: '"Access not Copy" - data stays in NHS servers.', position: 0, parties: ['nhs_gov', 'academic', 'patient'], status: 'Policy', source: 'https://www.hdruk.ac.uk', stats: [{ text: "Goldacre Review: SDEs are the only safe way to handle scale.", sourceUrl: "https://www.gov.uk" }], evidence: 10, equitability: 8, salience: 5 },
                    { id: 14, title: 'Commercial Clinical Trials', description: 'Streamlining recruitment for pharma studies.', position: 2, parties: ['nhs_gov', 'industry'], status: 'Policy', source: 'https://www.nihr.ac.uk', stats: [{ text: "O'Shaughnessy Review: aim to quadruple commercial trials by 2027.", sourceUrl: "https://www.gov.uk" }], evidence: 9, equitability: 6, salience: 6 },
                    { id: 15, title: 'Golden Share in IP', description: 'Govt retains a "Golden Share" to veto price hikes on drugs.', position: -3, parties: ['nhs_gov', 'patient'], status: 'Sensible', source: 'https://ucl.ac.uk/ippp', stats: [{ text: "Recommended by Mariana Mazzucato for mission-oriented innovation.", sourceUrl: "https://marianamazzucato.com" }], evidence: 6, equitability: 9, salience: 5 },
                    { id: 16, title: 'Levelling Up Data', description: 'Prioritizing data collection in under-represented regions.', position: -1, parties: ['nhs_gov', 'academic'], status: 'Policy', source: 'https://www.gov.uk', stats: [{ text: "Northern hospitals often have poorer data infrastructure.", sourceUrl: "https://thenorthernhealthsciencealliance.co.uk" }], evidence: 8, equitability: 8, salience: 4 },
                    { id: 17, title: 'Preferential Access for SMEs', description: 'Discounted access for UK startups vs global pharma.', position: 1, parties: ['nhs_gov', 'industry'], status: 'Sensible', source: 'https://www.abhi.org.uk', stats: [{ text: "UK Life Sciences vision prioritizes domestic growth.", sourceUrl: "https://www.gov.uk" }], evidence: 7, equitability: 7, salience: 5 },
                    { id: 18, title: 'Cost-Recovery Access', description: 'Charging only for compute/admin, not data value.', position: -2, parties: ['nhs_gov', 'academic'], status: 'Sensible', source: 'https://www.hdruk.ac.uk', stats: [{ text: "Standard academic model, but argued as subsidy for pharma.", sourceUrl: "https://www.kingsfund.org.uk" }], evidence: 8, equitability: 6, salience: 4 },
                    { id: 19, title: 'National Data Lake', description: 'Merging all GP data into one central pot.', position: 4, parties: ['nhs_gov'], status: 'Contested', source: 'https://digital.nhs.uk', stats: [{ text: "GPDPR failed due to centralization fears.", sourceUrl: "https://www.bma.org.uk" }], evidence: 10, equitability: 3, salience: 9 },
                    { id: 20, title: 'Emergency Powers Access', description: 'Bypassing consent for pandemic-level threats.', position: 2, parties: ['nhs_gov'], status: 'Policy', source: 'https://www.gov.uk', stats: [{ text: "COPI notices during Covid allowed unprecedented data flow.", sourceUrl: "https://digital.nhs.uk" }], evidence: 10, equitability: 5, salience: 6 }
                ]
            }
        };

        // --- Three.js Component ---
        const OvertonViz = ({ policies, activeParties, setHoveredPolicy, yAxisMode, ageGroup, theme, selectedPolicy, setSelectedPolicy, wobble, interestGroups }) => {
            const mountRef = useRef(null);
            const sceneRef = useRef(null);
            const cameraRef = useRef(null);
            const rendererRef = useRef(null);
            const spheresRef = useRef([]);
            const windowMeshRef = useRef(null);
            const frameIdRef = useRef(null);
            const raycaster = useRef(new THREE.Raycaster());
            const mouse = useRef(new THREE.Vector2(-1000, -1000));
            const gridHelperRef = useRef(null);
            const axisLinesRef = useRef([]);
            
            const yAxisModeRef = useRef(yAxisMode);
            const wobbleRef = useRef(wobble);
            const activePartiesRef = useRef(activeParties);

            useEffect(() => { yAxisModeRef.current = yAxisMode; }, [yAxisMode]);
            useEffect(() => { wobbleRef.current = wobble; }, [wobble]);
            useEffect(() => { activePartiesRef.current = activeParties; }, [activeParties]);

            const visiblePolicies = useMemo(() => {
                return policies.filter(p => p.parties.some(party => activeParties.includes(party)));
            }, [policies, activeParties]);

            const currentDataset = DATASETS.health_ip;
            const windows = currentDataset.windows;
            const currentWindow = windows[ageGroup] || windows['all'];
            const windowWidth = currentWindow.max - currentWindow.min;
            const windowCenter = (currentWindow.max + currentWindow.min) / 2;

            const bgColor = theme === 'dark' ? '#111827' : '#ffffff'; 
            const gridColor = theme === 'dark' ? 0x1f2937 : 0xe5e7eb;
            const axisColor = theme === 'dark' ? 0x4b5563 : 0x9ca3af; 

            const generateTexture = (colors) => {
                const canvas = document.createElement('canvas');
                canvas.width = 128;
                canvas.height = 128;
                const ctx = canvas.getContext('2d');
                if (colors.length === 1) {
                    ctx.fillStyle = colors[0];
                    ctx.fillRect(0, 0, 128, 128);
                } else {
                    const gradient = ctx.createLinearGradient(0, 0, 128, 0);
                    colors.forEach((c, i) => {
                        const start = i / colors.length;
                        const end = (i + 1) / colors.length;
                        gradient.addColorStop(start + 0.05, c);
                        gradient.addColorStop(end - 0.05, c);
                    });
                    ctx.fillStyle = gradient;
                    ctx.fillRect(0, 0, 128, 128);
                }
                return new THREE.CanvasTexture(canvas);
            };

            useEffect(() => {
                const width = mountRef.current.clientWidth || 1;
                const height = mountRef.current.clientHeight || 1;
                const scene = new THREE.Scene();
                scene.background = new THREE.Color(bgColor);
                scene.fog = new THREE.FogExp2(bgColor, 0.035);

                const camera = new THREE.PerspectiveCamera(50, width / height, 0.1, 100);
                camera.position.set(0, 5, 18); camera.lookAt(0, 2, 0);

                const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
                renderer.setSize(width, height);
                renderer.setPixelRatio(window.devicePixelRatio);
                mountRef.current.appendChild(renderer.domElement);

                sceneRef.current = scene;
                cameraRef.current = camera;
                rendererRef.current = renderer;

                scene.add(new THREE.AmbientLight(0xffffff, 0.6));
                const spotLight = new THREE.SpotLight(0xffffff, 1.5);
                spotLight.position.set(10, 20, 10);
                scene.add(spotLight);

                const boxGeo = new THREE.BoxGeometry(1, 10, 4); 
                const boxMat = new THREE.MeshPhongMaterial({ color: 0x14b8a6, transparent: true, opacity: 0.08 });
                const winMesh = new THREE.Mesh(boxGeo, boxMat);
                winMesh.position.y = 4;
                scene.add(winMesh);
                windowMeshRef.current = winMesh;

                const gridHelper = new THREE.GridHelper(40, 40, gridColor, gridColor); 
                gridHelper.position.y = -1;
                gridHelper.material.opacity = 0.4;
                gridHelper.material.transparent = true;
                scene.add(gridHelper);
                gridHelperRef.current = gridHelper;

                const handleMouseMove = (e) => {
                    const rect = renderer.domElement.getBoundingClientRect();
                    mouse.current.x = ((e.clientX - rect.left) / rect.width) * 2 - 1;
                    mouse.current.y = -((e.clientY - rect.top) / rect.height) * 2 + 1;
                };
                mountRef.current.addEventListener('mousemove', handleMouseMove);

                const handleClick = () => {
                    raycaster.current.setFromCamera(mouse.current, camera);
                    const intersects = raycaster.current.intersectObjects(spheresRef.current.map(s => s.mesh));
                    if (intersects.length > 0) {
                        setSelectedPolicy(spheresRef.current.find(s => s.mesh === intersects[0].object)?.data);
                    } else setSelectedPolicy(null);
                };
                mountRef.current.addEventListener('click', handleClick);

                const animate = () => {
                    frameIdRef.current = requestAnimationFrame(animate);
                    spheresRef.current.forEach((obj, idx) => {
                        const targetY = (obj.data[yAxisModeRef.current] || 0) * 0.8;
                        obj.mesh.position.y += (targetY - obj.mesh.position.y) * 0.08;
                        if (wobbleRef.current) {
                            obj.mesh.position.y += Math.sin(Date.now() * 0.0005 + obj.xPos + idx) * 0.003;
                        }
                    });
                    raycaster.current.setFromCamera(mouse.current, camera);
                    const intersects = raycaster.current.intersectObjects(spheresRef.current.map(s => s.mesh));
                    if (intersects.length > 0) {
                        setHoveredPolicy(spheresRef.current.find(s => s.mesh === intersects[0].object)?.data);
                    } else setHoveredPolicy(null);
                    renderer.render(scene, camera);
                };
                animate();

                return () => {
                    cancelAnimationFrame(frameIdRef.current);
                    renderer.dispose();
                };
            }, []);

            useEffect(() => {
                if (!sceneRef.current) return;
                spheresRef.current.forEach(s => sceneRef.current.remove(s.mesh));
                spheresRef.current = [];
                visiblePolicies.forEach(policy => {
                    const colors = policy.parties.filter(p => activeParties.includes(p)).map(id => interestGroups.find(g => g.id === id)?.color || '#fff');
                    const mesh = new THREE.Mesh(new THREE.IcosahedronGeometry(0.35, 1), new THREE.MeshStandardMaterial({ map: generateTexture(colors), emissive: colors[0], emissiveIntensity: 0.5 }));
                    mesh.position.set(policy.position, 0, 0);
                    sceneRef.current.add(mesh);
                    spheresRef.current.push({ mesh, xPos: policy.position, data: policy });
                });
            }, [visiblePolicies, activeParties]);

            useEffect(() => {
                if (windowMeshRef.current) {
                    windowMeshRef.current.position.x = windowCenter;
                    windowMeshRef.current.scale.x = windowWidth;
                }
            }, [ageGroup]);

            return <div ref={mountRef} className="w-full h-full relative" />;
        };

        // --- UI Components ---
        const DraggablePanel = ({ yAxisMode, setYAxisMode, ageGroup, setAgeGroup, activeParties, toggleParty, theme, setTheme, wobble, setWobble, interestGroups }) => {
            const [isOpen, setIsOpen] = useState(true);
            return (
                <div className={`absolute top-4 left-4 z-50 w-64 rounded-lg border shadow-xl transition-all ${theme === 'dark' ? 'bg-gray-900/90 border-gray-700 text-white' : 'bg-white/90 border-gray-200 text-black'}`}>
                    <div className="flex items-center justify-between p-3 border-b border-gray-700/50">
                        <span className="text-xs font-bold uppercase tracking-widest">Controls</span>
                        <button onClick={() => setIsOpen(!isOpen)}>{isOpen ? '−' : '+'}</button>
                    </div>
                    {isOpen && (
                        <div className="p-3 space-y-4 max-h-[500px] overflow-y-auto custom-scrollbar">
                            <div>
                                <label className="text-[10px] font-bold block mb-1 opacity-50">THEME</label>
                                <button onClick={() => setTheme(theme === 'dark' ? 'light' : 'dark')} className="text-xs bg-gray-800 px-2 py-1 rounded w-full">Toggle {theme === 'dark' ? 'Light' : 'Dark'}</button>
                            </div>
                            <div>
                                <label className="text-[10px] font-bold block mb-1 opacity-50">WINDOW</label>
                                <select value={ageGroup} onChange={e => setAgeGroup(e.target.value)} className="w-full bg-transparent border border-gray-700 rounded p-1 text-xs">
                                    {Object.entries(DATASETS.health_ip.windows).map(([k,v]) => <option key={k} value={k}>{v.label}</option>)}
                                </select>
                            </div>
                            <div className="space-y-1">
                                <label className="text-[10px] font-bold block mb-1 opacity-50">GROUPS</label>
                                {interestGroups.map(g => (
                                    <div key={g.id} className="flex items-center gap-2 text-xs">
                                        <input type="checkbox" checked={activeParties.includes(g.id)} onChange={() => toggleParty(g.id)} />
                                        <span style={{color: g.color}}>●</span>
                                        <span>{g.name}</span>
                                    </div>
                                ))}
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const Tooltip = ({ policy, theme }) => {
            if (!policy) return null;
            return (
                <div className={`absolute top-4 right-4 z-50 w-72 p-4 rounded-lg border shadow-2xl ${theme === 'dark' ? 'bg-gray-900 border-teal-500/50 text-white' : 'bg-white border-teal-500 text-black'}`}>
                    <h3 className="font-bold mb-1">{policy.title}</h3>
                    <p className="text-xs opacity-70 mb-2">{policy.description}</p>
                    <div className="text-[10px] uppercase font-bold text-teal-500">{policy.status}</div>
                </div>
            );
        };

        const App = () => {
            const [activeParties, setActiveParties] = useState(DATASETS.health_ip.groups.map(g => g.id));
            const [yAxisMode, setYAxisMode] = useState('evidence');
            const [ageGroup, setAgeGroup] = useState('all');
            const [theme, setTheme] = useState('dark');
            const [wobble, setWobble] = useState(true);
            const [hoveredPolicy, setHoveredPolicy] = useState(null);
            const [selectedPolicy, setSelectedPolicy] = useState(null);

            const toggleParty = (id) => setActiveParties(prev => prev.includes(id) ? prev.filter(p => p !== id) : [...prev, id]);

            return (
                <div className={`w-full min-h-screen ${theme === 'dark' ? 'bg-gray-950 text-white' : 'bg-gray-50 text-black'}`}>
                    <header className="p-6 text-center">
                        <h1 className="text-3xl font-bold uppercase tracking-tighter">Overton Window Ontology</h1>
                        <p className="opacity-50 text-sm">{DATASETS.health_ip.title}</p>
                    </header>
                    <div className="relative mx-auto max-w-6xl h-[600px] border border-gray-800 rounded-xl overflow-hidden bg-gray-900/20">
                        <DraggablePanel {...{yAxisMode, setYAxisMode, ageGroup, setAgeGroup, activeParties, toggleParty, theme, setTheme, wobble, setWobble}} interestGroups={DATASETS.health_ip.groups} />
                        <Tooltip policy={selectedPolicy || hoveredPolicy} theme={theme} />
                        <OvertonViz 
                            policies={DATASETS.health_ip.policies} 
                            {...{activeParties, setHoveredPolicy, setSelectedPolicy, selectedPolicy, yAxisMode, ageGroup, theme, wobble}} 
                            interestGroups={DATASETS.health_ip.groups} 
                        />
                    </div>
                    <div className="max-w-6xl mx-auto p-6 grid grid-cols-1 md:grid-cols-3 gap-4">
                        {DATASETS.health_ip.policies.filter(p => p.parties.some(party => activeParties.includes(party))).map(p => (
                            <div key={p.id} onClick={() => setSelectedPolicy(p)} className="p-4 border border-gray-800 rounded-lg hover:border-teal-500 cursor-pointer transition-colors bg-gray-900/10">
                                <h4 className="font-bold text-sm">{p.title}</h4>
                                <p className="text-[10px] opacity-60 line-clamp-2">{p.description}</p>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
